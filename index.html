<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Something to Report – Daily Briefings</title>

  <!-- SEO / Social -->
  <meta property="og:title" content="Something to Report – Daily Briefings">
  <meta property="og:description" content="Your daily 3-sentence news. Click to read.">
  <meta property="og:image" content="https://somethingtoreport.com/og-image.jpg">

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- === A2HS additions (start) === -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0f0f0f">
  <!-- iOS full-screen (optional icon provided; iOS can auto-generate if you remove this line) -->
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Something to Report">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <!-- === A2HS additions (end) === -->

  <style>
    /* ==== Reset & Base ==== */
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Inter', sans-serif;
      line-height: 1.6;
      transition: background 0.3s, color 0.3s;
    }
    a { text-decoration: none; color: inherit; }

    /* ==== Light Mode ==== */
    .light { background: #fafafa; color: #111; }
    .light .category { border-left-color: #000; }
    .light .news-toggle { color: #000; }
    .light .read-more { background: #000; color: #fff; }
    .light .read-more:hover { background: #333; }
    .light .controls button { background: #eee; }
    .light .controls button:hover { background: #ddd; }
    .light .pill { background:#fff; border-color:#ddd; color:#333; }
    .light .pill.active { outline:2px solid #000; }
    .light .breaking { background:#fff; border-color:#ddd; }

    /* ==== Dark Mode ==== */
    .dark { background: #0f0f0f; color: #eee; }
    .dark .category { border-left-color: #fff; }
    .dark .news-toggle { color: #fff; }
    .dark .read-more { background: #fff; color: #000; }
    .dark .read-more:hover { background: #ccc; }
    .dark .controls button { background: #222; color: #fff; }
    .dark .controls button:hover { background: #333; }
    .dark .pill { background:#1b1b1b; border-color:#333; color:#eee; }
    .dark .pill.active { outline:2px solid #fff; }
    .dark .breaking { background:#161616; border-color:#2a2a2a; }

    /* ==== Header ==== */
    header {
      text-align: center;
      padding: 2.5rem 1rem 1.5rem;
      border-bottom: 1px solid;
    }
    header h1 { font-weight: 300; font-size: 2.2rem; letter-spacing: -0.03em; }
    header .timestamp { font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.7; }

    /* ==== Controls (Dark Mode + Expand All) ==== */
    .controls {
      text-align: center;
      padding: 1rem;
      display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;
    }
    .controls button {
      padding: 0.6rem 1.2rem;
      border: none; border-radius: 6px;
      font-size: 0.9rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      /* no color changes here by request */
    }

    /* ==== Date Pills & Stamp ==== */
    .dates {
      max-width: 1400px; margin: 0 auto; padding: 0 1rem 1rem;
      display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; justify-content:center;
    }
    .pill {
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.5rem .9rem; border:1px solid; border-radius:999px; cursor:pointer;
      font-size:.85rem; font-weight:600; transition: box-shadow .2s ease, transform .2s ease;
    }
    .pill:hover { box-shadow: 0 6px 18px rgba(0,0,0,.12); transform: translateY(-1px); }
    .stamp { font-size:.85rem; opacity:.7; margin-left:.5rem; white-space:nowrap; }

    /* ==== Breaking Banner ==== */
    .breaking {
      max-width: 1400px; margin: 0 auto 0; padding: .9rem 1rem;
      border:1px solid; border-radius: 10px;
    }
    .breaking .bar { font-weight:700; margin-bottom:.25rem; }
    .breaking .body a { text-decoration: underline; }

    /* ==== Category Grid (3 per row on desktop) ==== */
    .categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      padding: 2rem 1rem;
      max-width: 1400px;
      margin: 0 auto;
    }
    .category {
      border-left: 4px solid;
      padding-left: 1rem;
    }
    .category h2 {
      font-weight: 400; font-size: 1.3rem; margin-bottom: 1rem;
      text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.8;
    }

    /* ==== News Item ==== */
    .news-item { margin-bottom: 1.2rem; }
    .news-toggle {
      cursor: pointer; display: flex; align-items: center; gap: 0.5rem;
      font-weight: 400; font-size: 1.05rem; padding: 0.4rem 0;
      transition: color 0.2s;
    }
    .news-toggle:hover { opacity: 0.8; }
    .news-toggle i { transition: transform 0.3s; font-size: 0.9rem; }

    /* === GPU-friendly open/close (replaces max-height animation) === */
    .news-panel {
      height: 0;
      overflow: hidden;
      opacity: 0;
      transform: translateY(6px);
      transition: height .28s ease, opacity .2s ease, transform .2s ease;
      padding: 0 1rem; /* vertical padding applied during open in JS */
      will-change: height, opacity, transform;
    }
    .news-panel.opening,
    .news-panel.closing { /* helper states during animation */ }

    .summary { font-size: 0.95rem; margin-bottom: 0.8rem; }
    .read-more {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-size: 0.85rem; font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .thumb img {
      width: 100%; height: auto; display: block;
      margin-top: 0.8rem; border-radius: 6px;
      opacity: 0; transition: opacity 0.4s;
    }
    .thumb img.loaded { opacity: 0.9; }

    /* ==== Empty state ==== */
    .no-results { opacity:.6; font-size:.9rem; padding:.3rem 0; display:none; }

    /* ==== Footer ==== */
    footer {
      text-align: center; padding: 2rem 1rem; font-size: 0.85rem;
      border-top: 1px solid; opacity: 0.7;
    }
    footer a { font-weight: 600; }

    /* Motion safety for users who prefer less motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    /* When low FPS is detected, disable transitions for instant toggles */
    .low-power * { transition: none !important; animation: none !important; }
  </style>
</head>

<body class="light">

  <!-- Header -->
  <header>
    <h1>Something to Report</h1>
    <div class="timestamp" id="current-time"></div>
  </header>

  <!-- Controls -->
  <div class="controls">
    <button id="expand-all">Expand All</button>
    <button id="dark-mode-toggle">Dark Mode</button>
  </div>

  <!-- Date pills + stamp -->
  <div class="dates" id="dates">
    <span class="stamp" id="stamp">Last updated --:--</span>
  </div>

  <!-- Breaking -->
  <div class="breaking" id="breaking" style="display:none;">
    <div class="bar" id="breakingBar"></div>
    <div class="body" id="breakingBody"></div>
  </div>

  <!-- Categories Grid -->
  <div class="categories">

    <!-- CATEGORY: Family -->
    <div class="category" data-section="family">
      <h2>Family</h2>
      <div class="list"></div>
      <div class="no-results">No family-focused briefings for this date.</div>
    </div>

    <!-- CATEGORY: Security -->
    <div class="category" data-section="security">
      <h2>Security</h2>
      <div class="list"></div>
      <div class="no-results">No security updates for this date.</div>
    </div>

    <!-- CATEGORY: Economy -->
    <div class="category" data-section="economy">
      <h2>Economy</h2>
      <div class="list"></div>
      <div class="no-results">No economy items for this date.</div>
    </div>

    <!-- CATEGORY: Health -->
    <div class="category" data-section="health">
      <h2>Health</h2>
      <div class="list"></div>
      <div class="no-results">No health items for this date.</div>
    </div>

    <!-- CATEGORY: Tech -->
    <div class="category" data-section="tech">
      <h2>Tech</h2>
      <div class="list"></div>
      <div class="no-results">No tech items for this date.</div>
    </div>

    <!-- CATEGORY: World -->
    <div class="category" data-section="world">
      <h2>World</h2>
      <div class="list"></div>
      <div class="no-results">No world items for this date.</div>
    </div>

  </div>

  <!-- Footer -->
  <footer>
    <p>Send tips: <a href="mailto:tips@somethingtoreport.com">tips@somethingtoreport.com</a></p>
    <p>© <span id="year"></span> Something to Report | <a href="#top">Back to Top</a></p>
  </footer>

  <!-- Scripts -->
  <script>
    // ===== Helpers =====
    const $=(s,el=document)=>el.querySelector(s);
    const $$=(s,el=document)=>[...el.querySelectorAll(s)];
    const pad=n=>String(n).padStart(2,'0');
    const toISO=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const toLabel=d=>`${pad(d.getMonth()+1)}-${pad(d.getDate())}-${d.getFullYear()}`;
    const fmtTime=d=>d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});

    // Current time in header
    const setHeaderTime=()=>{
      const now=new Date();
      $('#current-time').textContent = now.toLocaleDateString('en-US',{
        weekday:'long', month:'long', day:'numeric', year:'numeric'
      }) + ' — ' + fmtTime(now);
    };
    setHeaderTime(); setInterval(setHeaderTime, 30_000);

    // Footer year
    $('#year').textContent = new Date().getFullYear();

    // ===== Dark Mode =====
    const themeMeta = document.querySelector('meta[name="theme-color"]');
    const darkToggle = document.getElementById('dark-mode-toggle');

    function applyTheme(isDark){
      document.body.classList.toggle('dark', isDark);
      document.body.classList.toggle('light', !isDark);
      darkToggle.textContent = isDark ? 'Light Mode' : 'Dark Mode';
      localStorage.setItem('mode', isDark ? 'dark' : 'light');
      if (themeMeta) themeMeta.setAttribute('content', isDark ? '#0f0f0f' : '#fafafa');
    }

    // Respect saved mode
    (()=>{ applyTheme(localStorage.getItem('mode') === 'dark'); })();
    darkToggle.addEventListener('click', () => applyTheme(!document.body.classList.contains('dark')));

    // iOS PWA resume: re-apply theme in case Safari paused rendering
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) applyTheme(localStorage.getItem('mode') === 'dark');
    });

    // ===== Date pills (today / yesterday / day before) =====
    const datesEl = document.getElementById('dates');
    const stampEl = document.getElementById('stamp');
    const params=new URLSearchParams(location.search);
    const preset=params.get('date'); // MM-DD-YYYY
    const today=new Date();
    const d0=new Date(today), d1=new Date(today), d2=new Date(today);
    d1.setDate(today.getDate()-1); d2.setDate(today.getDate()-2);
    const days=[d0,d1,d2];
    const pills=[];
    days.forEach((d,i)=>{
      const pill=document.createElement('button');
      pill.type='button'; pill.className='pill';
      const label=toLabel(d);
      pill.dataset.date=label;
      pill.textContent = i===0 ? `Latest: ${label}` : label;
      datesEl.insertBefore(pill, stampEl);
      pills.push(pill);
    });

    // ===== Fetch daily JSON =====
    async function fetchNewsByLabel(dateLabel){
      const [mm,dd,yyyy]=dateLabel.split('-');
      const iso=`${yyyy}-${mm}-${dd}`;
      const url=`/data/news-${iso}.json`;
      const res=await fetch(url,{cache:'no-store'});
      if(!res.ok) throw new Error(`Missing JSON: ${url}`);
      return res.json();
    }

    // ===== PERF HELPERS: instant/smooth toggles =====
    const isIosStandalone = (window.navigator.standalone === true) ||
      window.matchMedia?.('(display-mode: standalone)').matches;

    // Adaptive low-power: if FPS is consistently low, disable transitions (instant toggles)
    (function adaptivePerf(){
      let frames = 0, start = performance.now();
      function sample(now){
        frames++;
        if (now - start >= 800) {
          const fps = Math.round(frames * 1000 / (now - start));
          document.body.classList.toggle('low-power', fps < 46);
          frames = 0; start = now;
        }
        requestAnimationFrame(sample);
      }
      requestAnimationFrame(sample);
    })();

    function preferInstantTransitions(){
      return isIosStandalone ||
             document.body.classList.contains('low-power') ||
             window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    }

    function togglePanel(panel, open){
      // instant mode for LPM / PWA / reduced motion
      if (preferInstantTransitions()) {
        panel.style.transition = 'none';
        panel.style.height = open ? 'auto' : '0px';
        panel.style.opacity = open ? '1' : '0';
        panel.style.transform = open ? 'translateY(0)' : 'translateY(6px)';
        panel.style.paddingTop = open ? '1rem' : '0';
        panel.style.paddingBottom = open ? '0.5rem' : '0';
        // restore transitions next tick
        requestAnimationFrame(()=> panel.style.transition = '');
        return;
      }

      // animated mode (height-based, GPU-friendly)
      const currentH = panel.style.height === 'auto'
        ? panel.scrollHeight
        : parseFloat(panel.style.height || '0');

      const targetH = open ? panel.scrollHeight : 0;

      // ensure starting values
      panel.style.height = currentH + 'px';
      panel.style.opacity = open ? '1' : '0';
      panel.style.transform = open ? 'translateY(0)' : 'translateY(6px)';
      panel.style.paddingTop = open ? '1rem' : '0';
      panel.style.paddingBottom = open ? '0.5rem' : '0';

      // animate to target on next frame
      requestAnimationFrame(()=>{
        panel.style.height = targetH + 'px';
      });

      const onDone = (e)=>{
        if (e.propertyName !== 'height') return;
        if (open) panel.style.height = 'auto';
        panel.removeEventListener('transitionend', onDone);
      };
      panel.addEventListener('transitionend', onDone);
    }

    // ===== Renderers =====
    function clearLists(){
      $$('.category').forEach(cat=>{
        const list=$('.list',cat); if(list) list.innerHTML='';
        const empty=$('.no-results',cat); if(empty) empty.style.display='none';
      });
    }

    function renderSection(sectionKey, items){
      const cat = $(`.category[data-section="${sectionKey}"]`);
      if(!cat) return;
      const list = $('.list',cat);
      list.innerHTML = '';
      let shown = 0;

      (items||[]).forEach(it=>{
        const item = document.createElement('div');
        item.className='news-item';

        const h = document.createElement('h3');
        h.className='news-toggle';
        h.innerHTML = `<i class="fas fa-chevron-down"></i> ${it.title || '(untitled)'}`;

        const panel = document.createElement('div');
        panel.className='news-panel';

        const summary = document.createElement('p');
        summary.className='summary';
        summary.textContent = it.summary || '';

        const link = document.createElement('a');
        link.href = it.url || '#';
        link.target = '_blank';
        link.rel = 'noopener';
        link.className='read-more';
        link.textContent = it.sourceLabel || 'Source';

        panel.appendChild(summary);
        panel.appendChild(link);

        // Optional image (lazy + async decode)
        if(it.image){
          const thumb=document.createElement('div'); thumb.className='thumb';
          const img=document.createElement('img');
          img.setAttribute('data-src', it.image);
          img.loading = 'lazy';
          img.decoding = 'async';
          thumb.appendChild(img); panel.appendChild(thumb);
        }

        item.appendChild(h);
        item.appendChild(panel);
        list.appendChild(item);

        // toggle (uses smooth/instant logic)
        h.addEventListener('click', ()=>{
          const icon = h.querySelector('i');
          const isOpen = panel.style.height === 'auto' || parseFloat(panel.style.height || '0') > 0;
          togglePanel(panel, !isOpen);
          icon.style.transform = !isOpen ? 'rotate(180deg)' : 'rotate(0deg)';
        });

        shown++;
      });

      const empty=$('.no-results',cat);
      if(empty) empty.style.display = shown ? 'none' : 'block';
    }

    function renderAll(data){
      // Breaking
      const wrap = document.getElementById('breaking');
      const bar = document.getElementById('breakingBar');
      const body = document.getElementById('breakingBody');
      if(data.breaking && (data.breaking.title || data.breaking.kicker)){
        bar.textContent = data.breaking.title || 'BREAKING';
        body.innerHTML = data.breaking.url
          ? `<a href="${data.breaking.url}" target="_blank" rel="noopener">${data.breaking.kicker || 'Open source ↗'}</a>`
          : (data.breaking.kicker || '');
        wrap.style.display='';
      } else {
        wrap.style.display='none';
      }

      // Sections map (match your original layout)
      const sections = {
        family:  data.family  || [],
        security:data.security|| [],
        economy: data.economy || [],
        health:  data.health  || [],
        tech:    data.tech    || [],
        world:   data.world   || []
      };

      Object.entries(sections).forEach(([k,arr])=>renderSection(k, arr));

      // Lazy load images
      $$('img[data-src]').forEach(img=>{
        img.src = img.dataset.src;
        img.onload = () => img.classList.add('loaded');
      });
    }

    // ===== Controller: apply a date =====
    async function applyDate(label){
      // highlight
      pills.forEach(p=>p.classList.toggle('active', p.dataset.date===label));
      // URL + stamp
      const url=new URL(location.href); url.searchParams.set('date', label); history.replaceState(null,'',url.toString());
      stampEl.textContent = `Last updated ${fmtTime(new Date())}`;

      // fetch + render
      clearLists();
      try{
        const json=await fetchNewsByLabel(label);
        renderAll(json);
      }catch(e){
        console.warn(e.message);
        renderAll({}); // empty
      }

      // Reset expand-all button label
      const expandBtn = document.getElementById('expand-all');
      if(expandBtn) expandBtn.textContent = 'Expand All';
    }

    // Hook pills
    pills.forEach(p=>p.addEventListener('click', ()=>applyDate(p.dataset.date)));

    // Initial selection
    const initial = preset && pills.some(p=>p.dataset.date===preset) ? preset : pills[0]?.dataset.date;
    if(initial) applyDate(initial);

    // ===== Expand/Collapse All (batched) =====
    const expandBtn = document.getElementById('expand-all');
    expandBtn.addEventListener('click', () => {
      const allPanels = document.querySelectorAll('.news-panel');
      const allIcons = document.querySelectorAll('.news-toggle i');
      const openAll = expandBtn.textContent.includes('Expand');

      // Batch DOM writes to avoid layout thrash
      requestAnimationFrame(() => {
        allPanels.forEach((panel, i) => {
          togglePanel(panel, openAll);
          if(allIcons[i]) allIcons[i].style.transform = openAll ? 'rotate(180deg)' : 'rotate(0deg)';
        });
        expandBtn.textContent = openAll ? 'Collapse All' : 'Expand All';
      });
    });

    // Smooth back to top
    document.querySelector('a[href="#top"]')?.addEventListener('click', e => {
      e.preventDefault();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  </script>

  <!-- === A2HS additions: service worker registration (start) === -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(console.error);
      });
    }
  </script>
  <!-- === A2HS additions: service worker registration (end) === -->
</body>
</html>