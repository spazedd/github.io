<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>somethingtoreport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#0f1011" />
  <meta name="description" content="Daily news" />
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Source+Code+Pro:wght@400;500&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <style>
    :root {
      --bg:#0a0a0a; --fg:#fff; --rule:#2a2a2a; --card:#111;
      --accent:#2563eb; --meta:#9aa0a6; --btn-fg:#fff;
      --chip-bg:#151515;
    }
    .light {
      --bg:#ffffff; --fg:#171717; 
      --rule:#e5e7eb; 
      --card:#fafafa; --accent:#2563eb; --meta:#666; --btn-fg:#fff;
      --chip-bg:#f4f4f5;
    }

    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{
      background:var(--bg);color:var(--fg);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      font-size: 14px;
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
      font-weight: 400;
    }
    a{color:inherit;text-decoration:none} a:hover{opacity:.8}
    
    /* Container */
    .container{
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    header{
      padding:40px 0 16px;
      border-bottom:1px solid var(--rule)
    }
    header h1{
      font-family: 'Inter', sans-serif;
      font-size: 1.8rem;
      font-weight: 500;
      letter-spacing: -0.02em;
      margin-bottom: 0.5rem;
      text-transform: lowercase;
    }
    .header-quote{
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      font-style: italic;
      line-height: 1.4;
      color: var(--meta);
      margin-bottom: 1rem;
      border-left: 2px solid var(--accent);
      padding-left: 1rem;
    }
    .date{
      font-family: 'Source Code Pro', monospace;
      font-size: 11px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--meta);
    }

    /* Controls */
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      padding:12px 0 0;
    }
    .control{
      display:flex;align-items:center;gap:8px;
      border:1px solid var(--rule);
      background:var(--chip-bg);
      padding:8px 12px;border-radius:999px;
    }
    .control label{
      font-family:'Source Code Pro',monospace;
      font-size:11px;letter-spacing:.06em;text-transform:uppercase;color:var(--meta);
    }
    .control select{
      background:transparent;border:none;color:var(--fg);outline:none;
      font-size:13px;
    }
    .count{
      margin-left:auto;
      font-family:'Source Code Pro',monospace;
      font-size:11px;letter-spacing:.06em;color:var(--meta);
    }
    .reset-btn{
      margin-left:0;
      border:1px solid var(--rule);background:transparent;color:var(--fg);
      padding:8px 12px;border-radius:999px;cursor:pointer;
    }
    .reset-btn:hover{background:var(--accent);border-color:var(--accent);color:var(--btn-fg);}

    /* Articles */
    .articles{
      display:flex;
      flex-direction:column;
      gap:1rem;
      margin:20px 0 2.5rem
    }

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 8px;border-radius:999px;border:1px solid var(--rule);
      background:var(--chip-bg);
      font-family:'Source Code Pro',monospace;
      font-size:10px;letter-spacing:.06em;text-transform:uppercase;color:var(--meta);
    }
    .badge .dot{width:6px;height:6px;border-radius:50%;display:inline-block}
    .cred{color:#fff;padding:3px 8px;border-radius:999px;font-weight:600;font-size:11px}
    .cred.c10,.cred.c9{background:#198754}
    .cred.c8,.cred.c7{background:#0d6efd}
    .cred.c6,.cred.c5{background:#6c757d}
    .cred.c4,.cred.c3{background:#fd7e14}
    .cred.c2,.cred.c1{background:#dc3545}

    /* Article Cards */
    .article{
      background:var(--card);
      border:1px solid var(--rule);
      border-radius:8px;
      padding:20px;
      transition: all .2s ease;
      cursor: pointer;
    }
    .article:hover{
      border-color:var(--accent);
    }
    .article.expanded{
      border-color:var(--accent);
      background:var(--card);
    }
    
    .article-header{
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }
    .article-title{
      font-family:'Inter',sans-serif;
      font-size:1.1rem;
      font-weight:500;
      line-height:1.4;
      flex: 1;
    }
    .expand-icon{
      transition: transform .3s ease;
      color: var(--meta);
      flex-shrink:0;
    }
    .article.expanded .expand-icon{
      transform: rotate(180deg);
    }
    .article-meta{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      font-family:'Source Code Pro',monospace;
      font-size:11px;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:var(--meta);
      margin:8px 0;
    }
    .article-summary{
      font-size:14px;
      line-height:1.5;
      color:var(--fg);
      opacity:.9;
      margin-bottom: 12px;
    }

    .article-details{
      overflow:hidden;
      max-height:0;
      opacity:0;
      transition:max-height .4s ease, opacity .4s ease;
      border-top: 1px solid var(--rule);
      padding-top: 16px;
      margin-top: 12px;
    }
    .article.expanded .article-details{
      opacity:1;
    }
    .article-content{
      font-size:14px;
      line-height:1.6;
      color:var(--fg);
      opacity:.9;
      margin-bottom: 16px;
    }

    .source-link{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:8px 16px;
      border-radius:6px;
      border:1px solid var(--rule);
      background:transparent;
      color:var(--fg);
      font-family: 'Source Code Pro', monospace;
      font-size: 11px;
      font-weight:500;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      transition:all .2s;
      text-decoration: none;
    }
    .source-link:hover{
      background:var(--accent);
      color:var(--btn-fg);
      border-color:var(--accent);
    }
    .source-link svg{width:12px;height:12px}

    footer{
      border-top:1px solid var(--rule);
      padding:30px 0;
      text-align:center;
      font-family:'Source Code Pro',monospace;
      font-size:11px;
      letter-spacing:.06em;
      color:var(--meta);
    }

    /* Theme Toggle */
    .theme-switch{
      position:fixed;
      top: 18px;
      right: 18px;
      z-index: 10000;
    }
    .theme-switch input{position:absolute;opacity:0;pointer-events:none}
    .theme-switch label{
      position:relative;display:inline-flex;align-items:center;
      width:40px;height:20px;border-radius:10px;border:1px solid var(--rule);
      background:var(--card);cursor:pointer;padding:2px;
    }
    .theme-switch label::after{
      content:"";position:absolute;width:14px;height:14px;border-radius:50%;
      background:var(--fg);transition:transform .25s ease;
    }
    .theme-switch input:checked + label::after{transform:translateX(20px)}

    @media (max-width:768px){
      .container{padding:0 16px;}
      header{padding:30px 0 15px}
      .header-quote{font-size:13px;padding-left:.8rem;}
      .article{padding:16px;}
    }
  </style>

  <!-- No-flash theme -->
  <script>
    (function () {
      const saved = localStorage.getItem("mode");
      const prefers = window.matchMedia("(prefers-color-scheme: dark)").matches;
      const dark = saved ? saved === "dark" : prefers;
      document.documentElement.classList.add(dark ? "dark" : "light");
    })();
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>somethingtoreport</h1>
      <div class="header-quote">"If the doors of perception were cleansed, every thing would appear to man as it is: Infinite."</div>
      <div class="date" id="currentDate"></div>

      <!-- Controls -->
      <div class="controls">
        <div class="control">
          <label for="categoryFilter">Category</label>
          <select id="categoryFilter">
            <option value="all">All</option>
            <option value="politics">Politics</option>
            <option value="economy">Economy</option>
            <option value="tech">Tech</option>
            <option value="world">World</option>
            <option value="security">Security</option>
            <option value="health">Health</option>
            <option value="family">Family</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="control">
          <label for="sortSelect">Sort</label>
          <select id="sortSelect">
            <option value="latest">Latest</option>
            <option value="cred">Credibility</option>
            <option value="title">Title</option>
          </select>
        </div>

        <button id="resetBtn" class="reset-btn">Reset</button>
        <div class="count" id="countWrap">0 stories</div>
      </div>
    </header>

    <main>
      <div id="newsArticles" class="articles"></div>
    </main>

    <footer>
      <p>Â© <span id="year"></span> somethingtoreport</p>
    </footer>
  </div>

  <!-- Theme Toggle -->
  <div class="theme-switch">
    <input type="checkbox" id="themeSwitch" aria-label="Toggle dark mode">
    <label for="themeSwitch" title="Toggle dark mode"></label>
  </div>

  <script>
    /* Utils */
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => [...document.querySelectorAll(s)];
    const pad = (n) => String(n).padStart(2,'0');
    const toYMD = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const prettyDate = (ds) => { 
      const [y,m,d] = ds.split('-').map(Number); 
      return new Date(y,m-1,d).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'}); 
    };

    // Current date in header
    const now = new Date();
    $("#currentDate").textContent = now.toLocaleDateString(undefined, {weekday:'long',year:'numeric',month:'long',day:'numeric'});
    $("#year").textContent = now.getFullYear();

    /* Theme toggle */
    function applyTheme(mode){
      document.documentElement.classList.toggle("dark", mode === 'dark');
      document.documentElement.classList.toggle("light", mode !== 'dark');
      try{ localStorage.setItem("mode", mode); }catch{}
    }
    (function initTheme(){
      const checkbox = document.getElementById('themeSwitch');
      const current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      applyTheme(current);
      if(checkbox){ 
        checkbox.checked = (current === 'dark');
        checkbox.addEventListener('change', function(){
          applyTheme(this.checked ? 'dark' : 'light');
        });
      }
    })();

    /* Client-side enrichment (category + credibility) */
    const DOMAIN_CRED = {
      "reuters.com":9,"apnews.com":9,"bbc.com":8,"bbc.co.uk":8,"wsj.com":8,"ft.com":8,"bloomberg.com":8,
      "nytimes.com":7,"theguardian.com":7,"politico.com":7,"axios.com":7,"marketwatch.com":7,
      "washingtonexaminer.com":6,"nationalreview.com":6,"city-journal.org":6,"nypost.com":5,"foxnews.com":5,"newsmax.com":4
    };
    function baseDomain(url){
      try{
        const u = new URL(url);
        const h = u.hostname.toLowerCase();
        const parts = h.split('.');
        if(parts.length >= 3 && ["co","com","org","net"].includes(parts[parts.length-2]) && ["uk","au"].includes(parts[parts.length-1])){
          return parts.slice(-3).join('.');
        }
        return parts.slice(-2).join('.');
      }catch{ return ""; }
    }
    function credibilityFor(url){
      const bd = baseDomain(url);
      return DOMAIN_CRED[bd] ?? 7; // sensible default
    }
    function categorize(title, details){
      const t = `${title} ${details}`.toLowerCase();
      if (/(election|senate|house|white house|biden|trump|policy|court|congress|governor)/.test(t)) return "politics";
      if (/(inflation|jobs|labor|unemployment|gdp|market|stocks|oil|tariff|trade|tax)/.test(t)) return "economy";
      if (/(ai|chip|semiconductor|apple|google|microsoft|meta|openai|startup|software|hardware|cyber)/.test(t)) return "tech";
      if (/(ukraine|israel|gaza|china|russia|iran|europe|asia|war|diplomacy|border)/.test(t)) return "world";
      if (/(crime|cartel|police|military|defense|security|terror|smuggling|fentanyl)/.test(t)) return "security";
      if (/(covid|flu|cdc|who|vaccine|cancer|hospital|mental health|obesity|opioid)/.test(t)) return "health";
      if (/(family|education|school|parents|marriage|birth|children|youth|culture|college)/.test(t)) return "family";
      return "other";
    }

    /* Controls */
    const elSort = $("#sortSelect");
    const elCat = $("#categoryFilter");
    const elCount = $("#countWrap");
    const elReset = $("#resetBtn");

    /* Data */
    const DAYS_BACK = 7;
    const MAX_CONSEC_MISSES = 5;

    async function fetchJSONOrNull(url){ 
      try{ 
        const r = await fetch(url, {cache: 'no-store'}); 
        if(!r.ok) return null; 
        return await r.json(); 
      } catch{ 
        return null; 
      } 
    }

    async function loadNews(){
      const articles = [];
      let misses = 0;
      
      for(let i = 0; i <= DAYS_BACK; i++){
        const d = new Date(); 
        d.setDate(d.getDate() - i);
        const ds = toYMD(d);
        const news = await fetchJSONOrNull(`./data/news-${ds}.json`);
        
        const hasNews = Array.isArray(news) && news.length > 0;
        misses = hasNews ? 0 : (misses + 1);
        
        if(hasNews) {
          news.forEach(article => {
            const category = categorize(article.title || "", article.details || "");
            const cred = credibilityFor(article.source || "");
            articles.push({
              ...article,
              dateStr: ds,
              _category: category,
              _cred: cred
            });
          });
        }
        if(misses >= MAX_CONSEC_MISSES) break;
      }
      return articles;
    }

    /* Create article card */
    function createCard(article){
      const el = document.createElement('article');
      el.className = 'article';
      const dateLine = prettyDate(article.dateStr);

      const credClass = `cred c${Math.max(1, Math.min(10, Math.round(article._cred)))}`;

      el.innerHTML = `
        <div class="article-header">
          <h3 class="article-title">${article.title}</h3>
          <div class="expand-icon" aria-hidden="true" title="Expand">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 9l6 6 6-6"></path>
            </svg>
          </div>
        </div>
        <div class="article-meta">
          <span class="badge"><span class="dot" style="background:${badgeColor(article._category)}"></span>${article._category}</span>
          <span class="badge">${dateLine}</span>
          <span class="${credClass}" title="Credibility (domain-based)"> ${article._cred}/10 </span>
        </div>
        <div class="article-summary">${article.summary || ''}</div>
        <div class="article-details">
          <div class="article-content">${article.details || ''}</div>
          ${article.source ? `
            <a href="${article.source}" class="source-link" target="_blank" rel="noopener">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                <polyline points="15 3 21 3 21 9"></polyline>
                <line x1="10" y1="14" x2="21" y2="3"></line>
              </svg>
              Read Full Story
            </a>
          ` : ''}
        </div>
      `;

      // Toggle expansion
      el.addEventListener('click', (e) => {
        if (e.target.closest('.source-link')) return; // don't close when clicking source
        const isExpanded = el.classList.contains('expanded');
        $$('.article').forEach(a => {
          a.classList.remove('expanded');
          const details = a.querySelector('.article-details');
          if (details) details.style.maxHeight = '0px';
        });
        if (!isExpanded) {
          el.classList.add('expanded');
          const details = el.querySelector('.article-details');
          if (details) details.style.maxHeight = details.scrollHeight + 'px';
        }
      });

      return el;
    }

    function badgeColor(cat){
      switch(cat){
        case "politics": return "#a855f7";
        case "economy": return "#22c55e";
        case "tech": return "#0ea5e9";
        case "world": return "#eab308";
        case "security": return "#ef4444";
        case "health": return "#10b981";
        case "family": return "#f97316";
        default: return "#6b7280";
      }
    }

    /* Filtering/Sorting/Rendering */
    let RAW = [];
    let VIEW = [];

    function applyControls(){
      const cat = elCat.value;
      VIEW = RAW.filter(s => cat === 'all' ? true : s._category === cat);

      const sort = elSort.value;
      if (sort === 'latest') {
        VIEW.sort((a,b) => a.dateStr < b.dateStr ? 1 : a.dateStr > b.dateStr ? -1 : 0);
      } else if (sort === 'cred') {
        VIEW.sort((a,b) => (b._cred ?? -1) - (a._cred ?? -1));
      } else if (sort === 'title') {
        VIEW.sort((a,b) => (a.title || '').localeCompare(b.title || ''));
      }

      renderArticles(VIEW);
      elCount.textContent = `${VIEW.length} stor${VIEW.length === 1 ? 'y' : 'ies'}`;
    }

    function renderArticles(articles){
      const container = $("#newsArticles");
      container.innerHTML = '';
      if(articles.length === 0){
        container.innerHTML = '<div style="text-align: center; color: var(--meta); padding: 40px;">No news articles found.</div>';
        return;
      }
      const frag = document.createDocumentFragment();
      articles.forEach(article => frag.appendChild(createCard(article)));
      container.appendChild(frag);
    }

    /* Initialize */
    (async function init(){
      const articles = await loadNews();
      RAW = articles;
      applyControls();
    })();

    // events
    elSort.addEventListener('change', applyControls);
    elCat.addEventListener('change', applyControls);
    elReset.addEventListener('click', () => {
      elCat.value = 'all';
      elSort.value = 'latest';
      applyControls();
    });
  </script>
</body>
</html>
