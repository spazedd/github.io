<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>somethingtoreport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#0f1011" />
  <meta name="description" content="Daily news and analysis" />
  <style>
    :root {
      --bg:#0a0a0a; --fg:#fff; --rule:#2a2a2a; --card:#111;
      --accent:#2563eb; --accent-alt:#dc2626; --meta:#9aa0a6;
      --btn-fg:#fff; --news-accent:#16a34a;
    }
    .light {
      --bg:#ffffff; --fg:#171717; --rule:#cbd5e1;
      --card:#fafafa; --accent:#2563eb; --accent-alt:#dc2626; --meta:#586274;
      --btn-fg:#fff; --news-accent:#16a34a;
    }

    body{background:var(--bg);color:var(--fg);font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;line-height:1.6;margin:0;min-height:100vh}
    .container{max-width:760px;margin:0 auto;padding:0 20px}

    header{padding:30px 0 20px;border-bottom:1px solid var(--rule)}
    header h1{font-size:2.4rem;font-weight:800;margin-bottom:.3rem}
    header p{opacity:.8}
    .date{color:var(--meta);font-size:.9rem;margin-top:.25rem}

    .controls{display:flex;gap:.6rem;padding:16px 0;align-items:center;flex-wrap:nowrap}
    .pills{display:flex;gap:.4rem;align-items:center;flex-wrap:wrap}
    .pills .label{opacity:.7;font-weight:700;margin-right:.25rem}
    .pill{height:40px;padding:0 .9rem;border-radius:999px;border:1px solid var(--rule);background:var(--card);color:var(--fg);font-weight:800;cursor:pointer;font-size:.9rem}
    .pill[aria-pressed="true"]{border-color:var(--accent-alt);background:color-mix(in oklab, var(--card) 85%, var(--accent-alt) 15%)}
    .spacer{flex:1 1 auto}

    .icon-btn{width:40px;height:40px;border-radius:10px;border:1px solid var(--rule);background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.2s;color:var(--fg)}
    .icon{width:1.1rem;height:1.1rem;stroke:currentColor;fill:none}

    .search-container{display:flex;align-items:center;gap:.5rem;margin-left:0;margin-right:0}
    .search-input{padding:.5rem .8rem;height:40px;border-radius:10px;border:1px solid var(--rule);background:var(--card);color:var(--fg);font-size:16px;width:0;opacity:0;transition:.3s}
    .search-input.expanded{width:220px;opacity:1}

    /* Theme slider (top-right) */
    .theme-switch{display:flex;align-items:center}
    .theme-switch input{position:absolute;opacity:0;pointer-events:none}
    .theme-switch label{position:relative;display:inline-flex;align-items:center;gap:.35rem;width:66px;height:32px;border-radius:999px;border:1px solid var(--rule);background:var(--card);cursor:pointer;box-shadow:inset 0 0 0 1px rgba(0,0,0,.02)}
    .theme-switch label::after{content:"";position:absolute;top:2px;left:2px;width:28px;height:28px;border-radius:50%;background:linear-gradient(#f9c86a,#eaa22d);transition:transform .25s ease, background .25s ease}
    .light .theme-switch label::after{background:linear-gradient(#f9c86a,#eaa22d)}
    .dark .theme-switch label::after{background:linear-gradient(#9aa0a6,#6b7280)}
    .theme-switch svg{width:14px;height:14px;stroke:currentColor;fill:none;opacity:.9}
    .theme-switch .sun{position:absolute;left:10px;color:#f59e0b}
    .theme-switch .moon{position:absolute;right:10px}
    .theme-switch input:checked + label::after{transform:translateX(34px)}
    @media (max-width:480px){ .theme-switch label{width:58px;height:30px} .theme-switch label::after{width:26px;height:26px} .theme-switch input:checked + label::after{transform:translateX(30px)} }


    .section-header{font-size:1.15rem;font-weight:800;margin:1.5rem 0 1rem;padding-bottom:.5rem;border-bottom:2px solid var(--accent)}
    .section-header.analysis{border-bottom-color:var(--accent-alt)}
    .section-header.earlier{opacity:.8;font-size:1rem;border-bottom-color:var(--rule)}

    .articles{display:flex;flex-direction:column;gap:1.2rem;margin:0 0 2.2rem}
    .article{background:var(--card);border:1.5px solid var(--rule);border-radius:16px;overflow:hidden;transition:transform .18s ease,border-color .18s ease,box-shadow .18s ease}
    .article:hover{transform:translateY(-2px);border-color:var(--accent)}
    .article.analysis{border-left:3px solid var(--accent-alt)}
    .article.news{border-left:3px solid var(--news-accent)}

    .article-header{padding:18px 18px 0}
    .article-title{font-size:1.2rem;font-weight:800;margin-bottom:.4rem}
    .article-body{padding:0 18px 14px}
    .article-meta{font-size:.92rem;opacity:.85;margin:.2rem 0 .8rem}

    .toggle-more,.open-full-btn{display:inline-flex;align-items:center;gap:.5rem;padding:.55rem 1rem;border-radius:10px;cursor:pointer;font-weight:800;font-size:.9rem;color:var(--btn-fg);border:1px solid;transition:filter .2s ease, transform .02s}
    .toggle-more{background:var(--news-accent);border-color:var(--news-accent)}
    .open-full-btn{background:var(--accent-alt);border-color:var(--accent-alt)}

    .collapsible{overflow:hidden;max-height:0;opacity:0;transition:max-height .5s ease, opacity .5s ease}
    .collapsible.open{opacity:1;margin-top:.25rem}

    footer{border-top:1px solid var(--rule);opacity:.85;text-align:center;padding:36px 0;font-size:.95rem}

    #backToTop{position:fixed;right:16px;bottom:16px;display:none;z-index:9999;border-radius:999px;border:1px solid var(--rule);background:var(--card);padding:.6rem .8rem;font-weight:800;cursor:pointer}
  
    /* --- Layout tweaks for mobile & de-cluttered header --- */
    @media (max-width:768px){
      /* Two-row grid: row1 (theme left, search right), row2 (pills full width) */
      .controls{display:grid;grid-template-columns:1fr auto;grid-template-areas:"theme search" "pills pills";row-gap:8px;column-gap:8px}
      .theme-switch{grid-area:theme}
      .search-container{grid-area:search;justify-self:end}
      .pills{grid-area:pills;overflow-x:auto;white-space:nowrap;padding-bottom:2px}
      .controls .spacer{display:none}
      /* Search input floats; expanding won't push pills underneath */
      .search-container{position:relative}
      .search-input{position:absolute;right:44px;top:0}
      .search-input.expanded{width:min(220px, calc(100vw - 120px));opacity:1}
    }
    @media (max-width:480px){
      .pills .label{display:none}
      .pill{padding:0 .8rem}
    }
  
    /* === Enhancements per request === */
    /* Fixed theme slider (top-right, always visible) */
    .theme-switch{position:fixed !important; top: max(12px, env(safe-area-inset-top)); right: max(12px, env(safe-area-inset-right)); z-index:10000}
    .theme-switch label{box-shadow:0 2px 10px rgba(0,0,0,.25), inset 0 0 0 1px rgba(0,0,0,.02)}

    /* Keep filter + search on the same row (desktop & mobile) */
    .controls{display:flex;align-items:center;gap:.6rem}
    .pills{flex:1 1 auto;white-space:nowrap;overflow-x:auto}
    .spacer{display:none}
    .search-container{margin-left:auto;position:relative}
    .search-input{position:absolute;right:44px;top:0}

    /* Mobile fine-tuning */
    @media (max-width:768px){
      .controls{gap:.5rem}
      .search-input.expanded{width:min(220px, calc(100vw - 140px));opacity:1}
      .pills .label{display:none}
      .pill{padding:0 .8rem}
    }
  </style>
  <!-- No-flash theme setup -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('mode');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const dark = saved ? saved === 'dark' : prefersDark;
        document.documentElement.classList.add(dark ? 'dark' : 'light');
      } catch (_) {
        document.documentElement.classList.add('dark');
      }
    })();
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>somethingtoreport</h1>
      <p>News reports and data analysis</p>
      <div class="date" id="currentDate"></div>

      <div class="controls">
        <div class="pills" role="group" aria-label="Content filter">
          <span class="label">Filter:</span>
          <button class="pill" data-filter="all" aria-pressed="true">All</button>
          <button class="pill" data-filter="news" aria-pressed="false">News</button>
          <button class="pill" data-filter="analysis" aria-pressed="false">Analysis</button>
        </div>
        <div class="spacer"></div>
        <div class="search-container">
          <input type="text" id="searchInput" class="search-input" placeholder="Search articles..." aria-label="Search">
          <button id="searchBtn" class="icon-btn" aria-label="Open search" title="Search">
            <svg class="icon" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
          </button>
        </div>
        <!-- Theme slider (top-right) -->
        <div class="theme-switch">
          <input type="checkbox" id="themeSwitch" aria-label="Toggle dark mode">
          <label for="themeSwitch" title="Toggle dark mode">
            <svg class="sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
            <svg class="moon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
          </label>
        </div>
        </div>
    </header>

    <!-- Overlay (restored) -->
    <div id="overlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="overlay-wrap">
        <div class="overlay-card">
          <button class="overlay-close" id="overlayClose">← Back</button>
          <div class="meta" id="ovKind"></div>
          <h2 id="ovTitle"></h2>
          <p class="lead" id="ovLead"></p>
          <div class="meta" id="ovDate"></div>
          <div class="content" id="ovContent"></div>
        </div>
      </div>
    </div>

    <main>
      <h2 class="section-header analysis" id="analysisHeader">Latest Analysis</h2>
      <div id="analysisArticles" class="articles"></div>

      <h2 class="section-header" id="newsHeader">Latest Reports</h2>
      <div id="newsArticles" class="articles"></div>

      <h3 class="section-header earlier" id="newsEarlierHeader">Earlier Reports</h3>
      <div id="newsEarlier" class="articles"></div>

      <h3 class="section-header analysis earlier" id="analysisEarlierHeader">Earlier Analysis</h3>
      <div id="analysisEarlier" class="articles"></div>
    </main>

    <footer>
      <p>© <span id="year"></span> somethingtoreport</p>
    </footer>
  </div>

  <button id="backToTop" title="Back to top">↑ Top</button>

  <script>
    /* Theme toggle logic (slider) */
    function applyTheme(mode){
      document.documentElement.classList.toggle('dark', mode === 'dark');
      document.documentElement.classList.toggle('light', mode !== 'dark');
      try { localStorage.setItem('mode', mode); } catch {}
    }
    (function initTheme(){
      var checkbox = document.getElementById('themeSwitch');
      var current = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
      applyTheme(current);
      if(checkbox){ checkbox.checked = (current === 'dark');
        checkbox.addEventListener('change', function(){
          applyTheme(this.checked ? 'dark' : 'light');
        });
      }
    })();

    const $ = (s) => document.querySelector(s);
    const $$ = (s) => [...document.querySelectorAll(s)];
    const pad = (n) => String(n).padStart(2,'0');
    const toYMD = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const prettyDate = (ds) => { const [y,m,d]=ds.split('-').map(Number); return new Date(y,m-1,d).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'}); };

    const now = new Date();
    $("#currentDate").textContent = now.toLocaleDateString(undefined, {weekday:'long',year:'numeric',month:'long',day:'numeric'});
    $("#year").textContent = now.getFullYear();

    const pills = $$('.pill');
    function setFilter(active){
      pills.forEach(b => b.setAttribute('aria-pressed', String(b.dataset.filter===active)));
      const show=(sel,on)=>{ const el=$(sel); if(el) el.style.display=on?'block':'none'; };
      if(active==='all'){
        show('#newsHeader',1); show('#newsArticles',1);
        show('#analysisHeader',1); show('#analysisArticles',1);
        show('#newsEarlierHeader',1); show('#newsEarlier',1);
        show('#analysisEarlierHeader',1); show('#analysisEarlier',1);
      } else if(active==='news'){
        show('#newsHeader',1); show('#newsArticles',1);
        show('#newsEarlierHeader',1); show('#newsEarlier',1);
        show('#analysisHeader',0); show('#analysisArticles',0);
        show('#analysisEarlierHeader',0); show('#analysisEarlier',0);
      } else {
        show('#newsHeader',0); show('#newsArticles',0);
        show('#newsEarlierHeader',0); show('#newsEarlier',0);
        show('#analysisHeader',1); show('#analysisArticles',1);
        show('#analysisEarlierHeader',1); show('#analysisEarlier',1);
      }
    }
    pills.forEach(b => b.addEventListener('click',()=> setFilter(b.dataset.filter)));

    const backToTop = $("#backToTop");
    backToTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
    window.addEventListener('scroll', ()=>{
      const cards = $$('.article');
      if(cards.length < 3) return;
      const third = cards[2];
      const threshold = third.getBoundingClientRect().top + window.scrollY - 80;
      backToTop.style.display = (window.scrollY > threshold) ? 'block' : 'none';
    }, {passive:true});
  
    /* ===== Restored app logic (search, JSON fetch, collapsibles, overlay) ===== */
    let currentSearch = ""; let searchOpen=false; let daysCache=[];
    const searchContainer=$('.search-container'), searchInput=$('#searchInput'), searchBtn=$('#searchBtn');
    function reRenderIfReady(){
      if (Array.isArray(daysCache) && daysCache.length > 0 && typeof renderRange === 'function') {
        renderRange(daysCache);
      }
    }
    searchBtn.addEventListener('click',(e)=>{ e.preventDefault(); searchOpen=!searchOpen;
      if(searchOpen){ searchInput.classList.add('expanded'); setTimeout(()=>searchInput.focus(),10); }
      else { searchInput.classList.remove('expanded'); if(!searchInput.value){ currentSearch=""; reRenderIfReady(); } }
    });
    searchInput.addEventListener('input',(e)=>{ currentSearch=(e.target.value||"").toLowerCase(); reRenderIfReady(); });
    document.addEventListener('click',(e)=>{ if(!searchOpen) return; if(!searchContainer.contains(e.target)){ if(!searchInput.value){ searchInput.classList.remove('expanded'); searchOpen=false; currentSearch=""; reRenderIfReady(); } } });
    function filterList(list){
      if(!currentSearch) return list||[];
      const q=currentSearch;
      return (list||[]).filter(a => ((a.title||"").toLowerCase().includes(q)) || ((a.summary||"").toLowerCase().includes(q)) || ((a.details||"").toLowerCase().includes(q)) );
    }

    const DAYS_BACK=10, MAX_CONSEC_MISSES=3;
    async function fetchJSONOrNull(url){ try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }catch{ return null; } }
    async function loadRange(daysBack=DAYS_BACK){
      const out=[]; let misses=0;
      for(let i=0;i<=daysBack;i++){
        const d=new Date(); d.setDate(d.getDate()-i);
        const ds=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const [news,analysis] = await Promise.all([
          fetchJSONOrNull(`./data/news-${ds}.json`),
          fetchJSONOrNull(`./data/analysis-${ds}.json`)
        ]);
        const has = (Array.isArray(news)&&news.length) || (Array.isArray(analysis)&&analysis.length);
        misses = has ? 0 : (misses+1);
        if(has) out.push({dateStr:ds, news:news||[], analysis:analysis||[]});
        if(misses>=MAX_CONSEC_MISSES) break;
      }
      return out;
    }

    function openCollapsible(el){ el.classList.add('open'); const h=el.scrollHeight; el.style.maxHeight=h+'px'; el.style.opacity='1'; }
    function closeCollapsible(el){ el.style.maxHeight = el.scrollHeight+'px'; requestAnimationFrame(()=>{ el.style.maxHeight='0px'; el.style.opacity='0'; el.addEventListener('transitionend', function end(){ el.classList.remove('open'); el.removeEventListener('transitionend', end); }); }); }

    const overlayEl=$('#overlay'), ovTitle=$('#ovTitle'), ovLead=$('#ovLead'), ovDate=$('#ovDate'), ovContent=$('#ovContent'), ovKind=$('#ovKind');
    function openOverlay(article, kind, dateStr){
      ovKind.textContent= kind==='analysis' ? 'Analysis' : '';
      ovTitle.textContent=article.title||'';
      ovLead.textContent=article.summary||'';
      ovDate.textContent=new Date(dateStr).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
      ovContent.textContent = '';
      const content = article.full || ('<p>' + (article.details||'') + '</p>');
      ovContent.innerHTML = content;
      overlayEl.classList.add('open'); overlayEl.setAttribute('aria-hidden','false');
      const bc=$('#overlayClose'); if(bc) bc.focus(); document.body.style.overflow='hidden';
    }
    function closeOverlay(){ overlayEl.classList.remove('open'); overlayEl.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
    document.addEventListener('click',(e)=>{ if(e.target && e.target.id==='overlayClose') closeOverlay(); if(e.target===overlayEl) closeOverlay(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape' && overlayEl.classList.contains('open')) closeOverlay(); });

    function createCard(article, kind, dateStr, {defaultOpen=false} = {}){
      const el=document.createElement('article');
      el.className=`article ${kind==='analysis'?'analysis':'news'}`;
      const dateLine=new Date(dateStr).toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'});
      el.innerHTML=`
        <div class=\"article-header\"><h3 class=\"article-title\">${article.title}</h3></div>
        <div class=\"article-body\">
          <p class=\"article-summary\">${article.summary||''}</p>
          <div class=\"article-meta\">${dateLine}</div>
          ${kind==='news' ? `
            <button class=\"toggle-more\" type=\"button\" aria-expanded=\"false\">
              <span class=\"chev\" aria-hidden=\"true\"><svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M6 9l6 6 6-6\"></path></svg></span>
              <span class=\"label\">+ Expand</span>
            </button>
            <div class=\"collapsible\" aria-hidden=\"true\"><div style=\"padding:.25rem 0 .5rem\"><p>${article.details||''}</p></div></div>` : ``}
        </div>
        ${kind==='analysis' ? `<div class=\"article-actions\"><button class=\"open-full-btn\" type=\"button\">Read Full Analysis</button></div>` : ``}
      `;
      if(kind==='news'){
        const toggle=el.querySelector('.toggle-more');
        const coll=el.querySelector('.collapsible');
        const label=toggle.querySelector('.label');
        const chev=toggle.querySelector('.chev');
        toggle.addEventListener('click', ()=>{
          const open = toggle.getAttribute('aria-expanded') === 'true';
          if(open){ toggle.setAttribute('aria-expanded','false'); label.textContent='+ Expand'; chev.style.transform='rotate(0deg)'; closeCollapsible(coll); coll.setAttribute('aria-hidden','true'); }
          else { toggle.setAttribute('aria-expanded','true'); label.textContent='Show less'; chev.style.transform='rotate(180deg)'; openCollapsible(coll); coll.setAttribute('aria-hidden','false'); }
        });
        if(defaultOpen){ toggle.setAttribute('aria-expanded','true'); label.textContent='Show less'; chev.style.transform='rotate(180deg)'; openCollapsible(coll); coll.setAttribute('aria-hidden','false'); }
      }
      if(kind==='analysis'){
        el.querySelector('.open-full-btn').addEventListener('click',()=> openOverlay(article,'analysis',dateStr));
      }
      return el;
    }

    function renderSection(list, container, headerEl, kind, opts={}){
      const items = filterList(list);
      if(items.length===0){ container.innerHTML=''; if(headerEl) headerEl.style.display='none'; return; }
      if(headerEl) headerEl.style.display='block';
      container.innerHTML='';
      items.forEach((a,i)=> container.appendChild(createCard(a, kind, a.dateStr, {defaultOpen:(kind==='news' && i < (opts.expandCount||0))})) );
    }

    function attachDate(list, dateStr){ return (list||[]).map(a=>({...a, dateStr})); }
    function renderRange(days){
      daysCache=days;
      const latest=days[0];
      const latestAnalysis = attachDate(latest?.analysis||[], latest?.dateStr||'');
      const latestNews = attachDate(latest?.news||[], latest?.dateStr||'');
      renderSection(latestAnalysis, $('#analysisArticles'), $('#analysisHeader'), 'analysis');
      renderSection(latestNews, $('#newsArticles'), $('#newsHeader'), 'news', {expandCount:2});
      const earlier=days.slice(1);
      const newsEarlierList = earlier.flatMap(d=>attachDate(d.news,d.dateStr));
      const analysisEarlierList = earlier.flatMap(d=>attachDate(d.analysis,d.dateStr));
      renderSection(analysisEarlierList, $('#analysisEarlier'), $('#analysisEarlierHeader'), 'analysis');
      renderSection(newsEarlierList, $('#newsEarlier'), $('#newsEarlierHeader'), 'news', {expandCount:0});
    }

    (async function init(){
      const days = await loadRange(10);
      if(!days.length) return; renderRange(days);
    })();
  </script>
</body>
</html>
