<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>somethingtoreport</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#0f1011" />
  <meta name="description" content="Daily news and analysis">

  <style>
    :root { --bg:#0a0a0a; --fg:#fff; --rule:#2a2a2a; --card:#111; --accent:#2563eb; --accent-alt:#dc2626; --meta:#9aa0a6; }
    .light { --bg:#fff; --fg:#171717; --rule:#e5e5e5; --card:#fafafa; --accent:#2563eb; --accent-alt:#dc2626; --meta:#666; }

    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth}
    body{background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.6;-webkit-font-smoothing:antialiased;min-height:100vh}
    a{color:inherit;text-decoration:none} a:hover{opacity:.85}
    .container{max-width:760px;margin:0 auto;padding:0 20px}

    header{padding:40px 0 20px;border-bottom:1px solid var(--rule)}
    header h1{font-size:2.4rem;font-weight:800;letter-spacing:-.02em;margin-bottom:.3rem}
    header p{opacity:.8}
    .date{opacity:.7;font-size:.95rem;margin-top:.25rem}

    .controls{display:flex;gap:.75rem;padding:16px 0;align-items:center;flex-wrap:wrap}
    .btn,.filter-select,.search-btn{height:44px}
    .btn{padding:0 .95rem;border-radius:10px;border:1px solid var(--rule);background:var(--card);cursor:pointer;font-weight:700;color:var(--fg);transition:.2s;font-size:.9rem;line-height:44px}
    .btn:hover{border-color:var(--accent)}
    .filter-select{padding:0 2rem 0 1rem;border-radius:10px;border:1px solid var(--rule);background:var(--card);color:var(--fg);font-size:16px;line-height:44px;cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right .6rem center;background-size:1rem}
    .search-container{display:flex;align-items:center;gap:.5rem;margin-left:auto;width:auto}
    .search-btn{padding:0 .75rem;border-radius:10px;border:1px solid var(--rule);background:var(--card);cursor:pointer;color:var(--fg);transition:.2s;display:flex;align-items:center;justify-content:center}
    .search-btn:hover{border-color:var(--accent);background:var(--accent);color:#fff}
    .search-icon{width:1.2rem;height:1.2rem;stroke:currentColor;fill:none}
    .search-input{padding:.5rem 1rem;border-radius:10px;border:1px solid var(--rule);background:var(--card);color:var(--fg);font-size:16px;width:0;opacity:0;transition:.3s}
    .search-input.expanded{width:220px;opacity:1}

    .section-header{font-size:1.15rem;font-weight:800;margin:1.5rem 0 1rem;padding-bottom:.5rem;border-bottom:2px solid var(--accent);display:inline-block}
    .section-header.analysis{border-bottom-color:var(--accent-alt)}

    .articles{display:flex;flex-direction:column;gap:1.2rem;margin:0 0 2.2rem}
    .article{background:var(--card);border:1px solid var(--rule);border-radius:16px;overflow:hidden}
    .article.analysis{border-left:3px solid var(--accent-alt)}
    .article-header{padding:18px 18px 0}
    .article-title{font-size:1.2rem;font-weight:800;letter-spacing:-.01em;line-height:1.3;margin-bottom:.4rem}
    .article-body{padding:0 18px 14px}
    .article-summary{margin-bottom:.5rem}
    .article-meta{font-size:.92rem;opacity:.8;margin:.2rem 0 .8rem}

    /* Analysis action */
    .open-full-btn{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem .9rem;background:var(--bg);border:1px solid var(--rule);border-radius:10px;cursor:pointer;font-weight:700;font-size:.9rem;color:var(--fg);transition:.2s}
    .open-full-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .article-actions{padding:0 18px 16px;display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}

    /* News dropdown */
    .toggle-more{display:inline-flex;align-items:center;gap:.45rem;padding:.45rem .75rem;margin:.2rem 0 .6rem;background:var(--bg);border:1px solid var(--rule);border-radius:10px;cursor:pointer;font-weight:700;font-size:.9rem;color:var(--fg);user-select:none;transition:.2s}
    .toggle-more:hover{background:var(--accent);color:#fff;border-color:var(--accent)}
    .chev{transition:transform .24s ease}
    .chev svg{width:1rem;height:1rem;display:block}
    .collapsible{overflow:hidden;max-height:0;opacity:0;transition:max-height .48s ease, opacity .48s ease}
    .collapsible.open{opacity:1;margin-top:.25rem}

    footer{border-top:1px solid var(--rule);opacity:.8;text-align:center;padding:36px 0;font-size:.95rem}

    /* Overlay */
    .overlay{position:fixed;inset:0;background:color-mix(in oklab, var(--bg) 96%, black 4%);display:none;z-index:9999}
    .overlay.open{display:block}
    .overlay-wrap{max-width:860px;margin:0 auto;height:100%;overflow:auto;padding:16px 18px 48px}
    .overlay-card{background:var(--card);border:1px solid var(--rule);border-radius:18px;padding:22px;margin-top:12px}
    .overlay h2{font-size:2rem;letter-spacing:-.02em;margin-bottom:.3rem}
    .overlay .lead{opacity:.9;margin:.6rem 0 1rem}
    .overlay .meta{opacity:.75;margin-bottom:1rem}
    .overlay .content{font-family:Georgia, 'Times New Roman', serif;line-height:1.7}
    .overlay .content h3{font-family:ui-sans-serif,system-ui;font-size:1.2rem;margin:1.1rem 0 .5rem}
    .overlay .content p{margin:.75rem 0}
    .overlay .content ul{margin:.5rem 0 .9rem 1.25rem}
    .overlay .content li{margin:.3rem 0}
    .callout{border-left:3px solid var(--accent);background:color-mix(in oklab, var(--card) 85%, var(--accent) 15%);padding:.75rem .9rem;border-radius:.6rem;margin:1rem 0}
    .overlay .toolbar{display:flex;gap:.6rem;flex-wrap:wrap;margin-top:1rem}
    .overlay .btn{height:auto;line-height:1.2;padding:.55rem .9rem}
    .overlay-close{position:sticky;top:8px;margin-left:auto;display:inline-flex;align-items:center;gap:.4rem;background:var(--bg);border:1px solid var(--rule);border-radius:10px;padding:.45rem .8rem;cursor:pointer;font-weight:700;color:var(--fg)}
    .overlay-close:hover{background:var(--accent);color:#fff;border-color:var(--accent)}

    /* Mobile */
    @media (max-width:768px){ .container{padding:0 16px} header{padding:28px 0 16px} header h1{font-size:2rem} .search-input.expanded{width:160px} }
    @media (max-width:480px){ .controls{flex-wrap:wrap} .btn,.filter-select{flex:1;min-width:120px} .search-container{width:auto;margin-top:.5rem;margin-left:auto;justify-content:flex-end} .search-container.open{width:100%;justify-content:stretch} .search-input.expanded{width:auto;flex:1;opacity:1} }
  </style>

  <script>
    /* Theme init (no flash) */
    (function () {
      const saved = localStorage.getItem("mode");
      const prefers = window.matchMedia("(prefers-color-scheme: dark)").matches;
      const dark = saved ? saved === "dark" : prefers;
      document.documentElement.classList.add(dark ? "dark" : "light");
    })();
  </script>
</head>
<body>
  <div class="container">
    <header>
      <h1>somethingtoreport</h1>
      <p>News reports and data analysis</p>
      <div class="date" id="currentDate"></div>

      <div class="controls">
        <button id="themeToggle" class="btn">Light Mode</button>
        <select id="contentFilter" class="filter-select" aria-label="Filter content">
          <option value="all">All Content</option>
          <option value="news">News Only</option>
          <option value="analysis">Analysis Only</option>
        </select>

        <div class="search-container">
          <input type="text" id="searchInput" class="search-input" placeholder="Search articles..." aria-label="Search">
          <button id="searchBtn" class="search-btn" aria-label="Open search">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </svg>
          </button>
        </div>
      </div>
    </header>

    <main>
      <h2 class="section-header" id="newsHeader">Latest Reports</h2>
      <div id="newsArticles" class="articles"></div>

      <h2 class="section-header analysis" id="analysisHeader">Latest Analysis</h2>
      <div id="analysisArticles" class="articles"></div>

      <h3 class="section-header" id="newsEarlierHeader">Earlier Reports</h3>
      <div id="newsEarlier" class="articles"></div>

      <h3 class="section-header analysis" id="analysisEarlierHeader">Earlier Analysis</h3>
      <div id="analysisEarlier" class="articles"></div>
    </main>

    <footer>
      <p>© <span id="year"></span> somethingtoreport</p>
    </footer>
  </div>

  <!-- Overlay (Full analysis) -->
  <div id="overlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="overlay-wrap">
      <button class="overlay-close" id="overlayClose">← Back</button>
      <div class="overlay-card">
        <div class="meta" id="ovKind"></div>
        <h2 id="ovTitle"></h2>
        <p class="lead" id="ovLead"></p>
        <div class="meta" id="ovDate"></div>
        <div class="content" id="ovContent"></div>
        <div class="toolbar">
          <button class="btn" onclick="window.print()">Save as PDF</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => [...document.querySelectorAll(s)];

    // Dates
    const today = new Date();
    const pad = (n) => String(n).padStart(2,'0');
    const toYMD = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    $("#currentDate").textContent = today.toLocaleDateString(undefined, {weekday:'long',year:'numeric',month:'long',day:'numeric'});
    $("#year").textContent = today.getFullYear();

    // Theme toggle
    const themeBtn = $("#themeToggle");
    function setTheme(isDark) {
      document.documentElement.classList.toggle("dark", isDark);
      document.documentElement.classList.toggle("light", !isDark);
      themeBtn.textContent = isDark ? "Light Mode" : "Dark Mode";
      localStorage.setItem("mode", isDark ? "dark" : "light");
    }
    setTheme(document.documentElement.classList.contains("dark"));
    themeBtn.addEventListener("click", () => setTheme(!document.documentElement.classList.contains("dark")));

    // ===== CONFIG (JSON ONLY) =====
    const DAYS_BACK = 30;           // how far back to look for files
    const MAX_CONSEC_MISSES = 7;    // stop early if many empty days

    // Helpers
    function prettyDate(ds){ const [y,m,d] = ds.split('-').map(Number); const dt=new Date(y,m-1,d);
      return dt.toLocaleDateString(undefined,{year:'numeric',month:'long',day:'numeric'}); }
    async function fetchJSONOrNull(url){ try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) return null; return await r.json(); }catch{ return null; } }

    // Load newest day first, then earlier days (newest → older)
    async function loadRange(daysBack=DAYS_BACK){
      const out=[]; let misses=0;
      for (let i=0;i<=daysBack;i++){
        const d = new Date(); d.setDate(d.getDate()-i);
        const ds = toYMD(d);
        const [news, analysis] = await Promise.all([
          fetchJSONOrNull(`./data/news-${ds}.json`),
          fetchJSONOrNull(`./data/analysis-${ds}.json`)
        ]);
        const has = (Array.isArray(news)&&news.length) || (Array.isArray(analysis)&&analysis.length);
        misses = has ? 0 : (misses+1);
        if (has) out.push({ dateStr: ds, news: news||[], analysis: analysis||[] });
        if (misses>=MAX_CONSEC_MISSES) break;
      }
      return out; // newest first by construction
    }

    // Search
    let currentSearch=''; let isSearchExpanded=false; let daysCache=[];
    const searchContainer=$(".search-container"), searchInput=$("#searchInput");
    $("#searchBtn").addEventListener('click',()=>{
      isSearchExpanded=!isSearchExpanded;
      if(isSearchExpanded){ searchContainer.classList.add('open'); searchInput.classList.add('expanded'); searchInput.focus(); }
      else { searchInput.classList.remove('expanded'); searchContainer.classList.remove('open'); if(!searchInput.value){ currentSearch=''; renderRange(daysCache); } }
    });
    $("#searchInput").addEventListener('input',e=>{ currentSearch=e.target.value.toLowerCase(); renderRange(daysCache); });
    document.addEventListener('click',e=>{
      if(isSearchExpanded && !searchContainer.contains(e.target)){
        if(!searchInput.value){ searchInput.classList.remove('expanded'); searchContainer.classList.remove('open'); isSearchExpanded=false; }
      }
    });

    function filterList(list){
      if(!currentSearch) return list;
      const q=currentSearch;
      return list.filter(a =>
        (a.title||'').toLowerCase().includes(q) ||
        (a.summary||'').toLowerCase().includes(q) ||
        (a.details||'').toLowerCase().includes(q)
      );
    }

    // Collapsible (news)
    function openCollapsible(el){ el.classList.add('open'); const h=el.scrollHeight; el.style.maxHeight=h+'px'; el.style.opacity='1'; }
    function closeCollapsible(el){
      el.style.maxHeight = el.scrollHeight+'px';
      requestAnimationFrame(()=>{ el.style.maxHeight='0px'; el.style.opacity='0';
        el.addEventListener('transitionend', function end(){ el.classList.remove('open'); el.removeEventListener('transitionend', end); }); });
    }

    // Cards
    function createCard(article, kind, dateStr){
      const el=document.createElement('article');
      el.className=`article ${kind==='analysis'?'analysis':''}`;
      const dateLine = prettyDate(dateStr);

      el.innerHTML=`
        <div class="article-header">
          <h3 class="article-title">${article.title}</h3>
        </div>
        <div class="article-body">
          <p class="article-summary">${article.summary||''}</p>
          <div class="article-meta">${dateLine}</div>

          ${kind==='news' ? `
            <button class="toggle-more" type="button" aria-expanded="false">
              <span class="chev" aria-hidden="true"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"></path></svg></span>
              <span class="label">Read more</span>
            </button>
            <div class="collapsible" aria-hidden="true">
              <div style="padding:.25rem 0 .5rem">
                <p>${article.details||''}</p>
              </div>
            </div>
          ` : ``}
        </div>

        ${kind==='analysis' ? `
          <div class="article-actions">
            ${article.full ? `<button class="open-full-btn" type="button">Full analysis</button>` : ``}
          </div>
        ` : ``}
      `;

      if (kind==='news'){
        const toggle = el.querySelector('.toggle-more');
        const coll = el.querySelector('.collapsible');
        const label = toggle.querySelector('.label');
        const chev = toggle.querySelector('.chev');
        toggle.addEventListener('click', ()=>{
          const open = toggle.getAttribute('aria-expanded') === 'true';
          if (open) {
            toggle.setAttribute('aria-expanded','false');
            label.textContent = 'Read more';
            chev.style.transform = 'rotate(0deg)';
            closeCollapsible(coll);
            coll.setAttribute('aria-hidden','true');
          } else {
            toggle.setAttribute('aria-expanded','true');
            label.textContent = 'Show less';
            chev.style.transform = 'rotate(180deg)';
            openCollapsible(coll);
            coll.setAttribute('aria-hidden','false');
          }
        });
      }

      if (kind==='analysis' && article.full){
        el.querySelector('.open-full-btn').addEventListener('click', ()=>{
          openOverlay(article, 'analysis', dateStr);
        });
      }

      return el;
    }

    function renderSection(list, container, headerEl, kind){
      const items = filterList(list);
      if (items.length === 0) { container.innerHTML=''; if (headerEl) headerEl.style.display='none'; return; }
      if (headerEl) headerEl.style.display='block';
      container.innerHTML='';
      items.forEach(a => container.appendChild(createCard(a, kind, a.dateStr)));
    }

    // Overlay
    const overlay=$("#overlay"), ovTitle=$("#ovTitle"), ovLead=$("#ovLead"), ovDate=$("#ovDate"), ovContent=$("#ovContent"), ovKind=$("#ovKind");
    function openOverlay(article, kind, dateStr){
      ovKind.textContent='Analysis';
      ovTitle.textContent=article.title;
      ovLead.textContent=article.summary||'';
      ovDate.textContent=prettyDate(dateStr);
      ovContent.innerHTML=article.full || `<p>${article.details||''}</p>`;
      overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false');
      $("#overlayClose").focus(); document.body.style.overflow='hidden';
    }
    function closeOverlay(){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); document.body.style.overflow=''; }
    $("#overlayClose").addEventListener('click', closeOverlay);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeOverlay(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlay.classList.contains('open')) closeOverlay(); });

    // Filter dropdown
    $("#contentFilter").addEventListener('change', (e)=>{
      const v=e.target.value, show=(sel,on)=>{const el=$(sel); if(el) el.style.display=on?'block':'none';};
      if(v==='all'){ show('#newsHeader',1); show('#newsArticles',1); show('#analysisHeader',1); show('#analysisArticles',1); show('#newsEarlierHeader',1); show('#newsEarlier',1); show('#analysisEarlierHeader',1); show('#analysisEarlier',1); }
      else if(v==='news'){ show('#newsHeader',1); show('#newsArticles',1); show('#newsEarlierHeader',1); show('#newsEarlier',1); show('#analysisHeader',0); show('#analysisArticles',0); show('#analysisEarlierHeader',0); show('#analysisEarlier',0); }
      else { show('#newsHeader',0); show('#newsArticles',0); show('#newsEarlierHeader',0); show('#newsEarlier',0); show('#analysisHeader',1); show('#analysisArticles',1); show('#analysisEarlierHeader',1); show('#analysisEarlier',1); }
    });

    // Render newest at top + earlier under it
    function attachDate(list, dateStr){ return (list||[]).map(a => ({...a, dateStr})); }

    async function renderRange(days){
      daysCache = days;
      const latest = days[0];
      if (latest){
        $("#currentDate").textContent = new Date(latest.dateStr).toLocaleDateString(undefined, {weekday:'long',year:'numeric',month:'long',day:'numeric'});
      }

      const latestNews = attachDate(latest?.news||[], latest?.dateStr||'');
      const latestAnalysis = attachDate(latest?.analysis||[], latest?.dateStr||'');
      renderSection(latestNews, $("#newsArticles"), $("#newsHeader"), 'news');
      renderSection(latestAnalysis, $("#analysisArticles"), $("#analysisHeader"), 'analysis');

      const earlier = days.slice(1);
      const newsEarlierList = earlier.flatMap(d => attachDate(d.news, d.dateStr));
      const analysisEarlierList = earlier.flatMap(d => attachDate(d.analysis, d.dateStr));
      renderSection(newsEarlierList, $("#newsEarlier"), $("#newsEarlierHeader"), 'news');
      renderSection(analysisEarlierList, $("#analysisEarlier"), $("#analysisEarlierHeader"), 'analysis');
    }

    (async function init(){
      $("#year").textContent = new Date().getFullYear();
      const days = await loadRange(DAYS_BACK);
      renderRange(days);
    })();
  </script>
</body>
</html>
